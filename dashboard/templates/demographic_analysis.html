{% extends "base.html" %}
{% load static %}
{% block title %}Demographic Analysis{% endblock %}
{% block content %}
<div class="main-container">
    <h1 class="page-title">Demographic Analysis</h1>
    
    <div class="card-custom mb-4">
        <form method="GET">
            <div class="row align-items-end">
                <div class="col-md-12">
                    <label for="post" class="form-label">Select Post to Analyze:</label>
                    <select name="post" id="post" class="form-select" onchange="this.form.submit()" required>
                        <option value="">-- Select a Post --</option>
                        {% for post in posts %}
                        <option value="{{ post.postid }}" {% if post.postid|stringformat:"s" == selected_post_id %}selected{% endif %}>
                            #{{ post.postid }} - {{ post.clusterid.clustername }} - {{ post.postmessage|truncatewords:10 }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    {% if selected_post %}
    <div class="card-custom mb-4">
        <h3 class="text-primary mb-3">Selected Post Details</h3>
        <p><strong>Post ID:</strong> #{{ selected_post.postid }}</p>
        <p><strong>Cluster:</strong> <span class="badge bg-info">{{ selected_post.clusterid.clustername }}</span></p>
        <p><strong>Message:</strong> {{ selected_post.postmessage }}</p>
    </div>

    <!-- Malaysian Map with State Data -->
    <div class="card-custom mb-4">
        <h3 class="mb-4">üìç Sentiment Distribution by State</h3>
        
        {% if map_chart %}
        <div class="chart-container mb-4">
            {{ map_chart|safe }}
        </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-8">
                <div class="table-responsive">
                    <table class="table table-hover table-custom">
                        <thead>
                            <tr>
                                <th>State</th>
                                <th class="text-center">Total Responses</th>
                                <th class="text-center">Positive</th>
                                <th class="text-center">Negative</th>
                                <th class="text-center">Neutral</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in state_data %}
                            <tr>
                                <td><strong>{{ data.state }}</strong></td>
                                <td class="text-center">{{ data.total }}</td>
                                <td class="text-center">
                                    <span class="text-success fw-bold">{{ data.positive }}</span>
                                    <small class="text-muted">({{ data.positive_pct }}%)</small>
                                </td>
                                <td class="text-center">
                                    <span class="text-danger fw-bold">{{ data.negative }}</span>
                                    <small class="text-muted">({{ data.negative_pct }}%)</small>
                                </td>
                                <td class="text-center">
                                    <span class="text-secondary fw-bold">{{ data.neutral }}</span>
                                    <small class="text-muted">({{ data.neutral_pct }}%)</small>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">No state-wise data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-4">
                <div class="map-legend">
                    <h5 class="mb-3">Legend</h5>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #2ecc71;"></span>
                        <span>Positive Sentiment</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #e74c3c;"></span>
                        <span>Negative Sentiment</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #95a5a6;"></span>
                        <span>Neutral Sentiment</span>
                    </div>
                    <hr>
                    <h6 class="mt-3">Top States by Response Count</h6>
                    {% for data in state_data|slice:":5" %}
                    <div class="top-state-item">
                        <strong>{{ forloop.counter }}. {{ data.state }}</strong>
                        <span class="badge bg-primary">{{ data.total }} responses</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Gender Distribution Chart -->
    <div class="chart-container mb-4">
        {{ gender_chart|safe }}
    </div>

    <!-- Age Group Distribution Chart -->
    <div class="chart-container mb-4">
        {{ age_chart|safe }}
    </div>

    {% else %}
    <div class="card-custom text-center py-5">
        <h3 class="text-primary mb-3">üìä Select a Post to View Demographics</h3>
        <p class="text-muted fs-5">Choose a post from the dropdown above to view detailed demographic analysis.</p>
    </div>
    {% endif %}
</div>

<style>
.map-legend {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.legend-color {
    width: 30px;
    height: 20px;
    border-radius: 4px;
    margin-right: 10px;
    display: inline-block;
}

.top-state-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #dee2e6;
}

.top-state-item:last-child {
    border-bottom: none;
}
</style>
{% endblock %}