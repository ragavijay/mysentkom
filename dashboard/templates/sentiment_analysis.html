{% extends "base.html" %}
{% load static %}
{% block title %}Sentiment Analysis{% endblock %}
{% block content %}
<div class="main-container">
    <h1 class="page-title">Sentiment Analysis</h1>
    
    <div class="card-custom mb-4">
        <form method="GET">
            <div class="row align-items-end">
                <div class="col-md-12">
                    <label for="post" class="form-label">Select Post to Analyze:</label>
                    <select name="post" id="post" class="form-select" onchange="this.form.submit()" required>
                        <option value="">-- Select a Post --</option>
                        {% for post in posts %}
                        <option value="{{ post.postid }}" {% if post.postid|stringformat:"s" == selected_post_id %}selected{% endif %}>
                            #{{ post.postid }} - {{ post.clusterid.clustername }} - {{ post.postmessage|truncatewords:10 }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    {% if selected_post %}
    <div class="card-custom mb-4">
        <h3 class="text-primary mb-3">Selected Post Details</h3>
        <p><strong>Post ID:</strong> #{{ selected_post.postid }}</p>
        <p><strong>Cluster:</strong> <span class="badge bg-info">{{ selected_post.clusterid.clustername }}</span></p>
        <p><strong>Message:</strong> {{ selected_post.postmessage }}</p>
        <p><strong>Link:</strong> <a href="{{ selected_post.postlink }}" target="_blank" class="text-primary">{{ selected_post.postlink }}</a></p>
        <p><strong>Total Responses:</strong> <span id="total-responses">{{ total_responses }}</span></p>
    </div>

    <!-- Power BI Style Slicers -->
    <div class="slicers-container">
        <h4 class="mb-4">ðŸ“Š Filter Sentiment Data</h4>
        
        <div class="row">
            <!-- Gender Slicer -->
            <div class="col-md-3">
                <div class="slicer-group">
                    <label class="slicer-title" for="genderSelect">Gender</label>
                    <select id="genderSelect" class="slicer-select {% if gender_filter %}filtered{% endif %}" 
                            onchange="applyFilter('gender', this.value)">
                        <option value="">All</option>
                        {% for code, label in genders %}
                        <option value="{{ code }}" {% if gender_filter == code %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Age Group Slicer -->
            <div class="col-md-3">
                <div class="slicer-group">
                    <label class="slicer-title" for="ageSelect">Age Group</label>
                    <select id="ageSelect" class="slicer-select {% if agegroup_filter %}filtered{% endif %}" 
                            onchange="applyFilter('agegroup', this.value)">
                        <option value="">All</option>
                        {% for age in age_groups %}
                        <option value="{{ age.agegroupid }}" {% if agegroup_filter == age.agegroupid|stringformat:"s" %}selected{% endif %}>
                            {{ age.agegroup }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- State Slicer -->
            <div class="col-md-3">
                <div class="slicer-group">
                    <label class="slicer-title" for="stateSelect">State</label>
                    <select id="stateSelect" class="slicer-select {% if state_filter %}filtered{% endif %}" 
                            onchange="applyFilter('state', this.value)">
                        <option value="">All</option>
                        {% for state in states %}
                        <option value="{{ state.stateid }}" {% if state_filter == state.stateid|stringformat:"s" %}selected{% endif %}>
                            {{ state.statename }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Date Range Slider -->
            <div class="col-md-3">
                <div class="slicer-group">
                    <label class="slicer-title">Date Range</label>
                    <div class="date-range-slider">
                        <input type="range" id="dateSliderFrom" class="slider" 
                               min="0" max="100" value="0" step="1" oninput="updateDateSlider()">
                        <input type="range" id="dateSliderTo" class="slider" 
                               min="0" max="100" value="100" step="1" oninput="updateDateSlider()">
                        <div class="slider-track"></div>
                        <div class="slider-labels">
                            <span id="sliderFromLabel" class="slider-label">{{ min_date|date:"d-m-Y" }}</span>
                            <span id="sliderToLabel" class="slider-label">{{ max_date|date:"d-m-Y" }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Filters & Clear Button -->
        {% if gender_filter or agegroup_filter or state_filter or date_from or date_to %}
        <div class="active-filters">
            <strong>Active Filters:</strong>
            {% if gender_filter %}
            <span class="filter-badge">
                Gender: 
                {% if gender_filter == 'M' %}Male
                {% elif gender_filter == 'F' %}Female
                {% elif gender_filter == 'O' %}Others
                {% elif gender_filter == 'N' %}Not Disclosed{% endif %}
            </span>
            {% endif %}
            {% if agegroup_filter %}
            <span class="filter-badge">
                Age: {% for age in age_groups %}{% if age.agegroupid|stringformat:"s" == agegroup_filter %}{{ age.agegroup }}{% endif %}{% endfor %}
            </span>
            {% endif %}
            {% if state_filter %}
            <span class="filter-badge">
                State: {% for state in states %}{% if state.stateid|stringformat:"s" == state_filter %}{{ state.statename }}{% endif %}{% endfor %}
            </span>
            {% endif %}
            {% if date_from or date_to %}
            <span class="filter-badge">
                Date: {{ date_from|date:"Y-m-d" }} to {{ date_to|date:"Y-m-d" }}
            </span>
            {% endif %}
            <button type="button" class="btn btn-sm clear-filters-btn" onclick="clearAllFilters()">Clear All Filters</button>
        </div>
        {% endif %}
    </div>

    <!-- Sentiment Pie Chart -->
    <div class="chart-container" id="chartContainer">
        {{ sentiment_chart|safe }}
    </div>

    <!-- User Responses -->
    <div class="card-custom">
        <h3 class="mb-4">User Responses (<span id="response-count">{{ total_responses }}</span> total)</h3>
        <div id="responses-container">
            {% include 'responses_list.html' %}
        </div>
    </div>

    {% else %}
    <div class="card-custom text-center py-5">
        <h3 class="text-primary mb-3">ðŸ“Š Select a Post to Begin Analysis</h3>
        <p class="text-muted fs-5">Choose a post from the dropdown above to view detailed sentiment analysis.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<style>
.date-range-slider {
    position: relative;
    margin-top: 10px;
}

.slider {
    position: absolute;
    width: 100%;
    height: 5px;
    top: 50%;
    left: 0;
    margin: 0;
    padding: 0;
    pointer-events: none;
    -webkit-appearance: none;
    appearance: none;
    background: none;
    z-index: 5;
}

.slider::-webkit-slider-thumb {
    pointer-events: auto;
    -webkit-appearance: none;
    appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #3498db;
    cursor: pointer;
    border: 2px solid #2980b9;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.slider::-moz-range-thumb {
    pointer-events: auto;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #3498db;
    cursor: pointer;
    border: 2px solid #2980b9;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.slider-track {
    width: 100%;
    height: 5px;
    background: #ecf0f1;
    border-radius: 5px;
    position: relative;
    margin-top: 10px;
}

.slider-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 12px;
    color: #7f8c8d;
    font-weight: 500;
}

.slider-label {
    background: #ecf0f1;
    padding: 4px 8px;
    border-radius: 3px;
}
</style>

<script>
const postId = '{{ selected_post_id }}';
const minDateObj = new Date('{{ min_date|date:"Y-m-d" }}');
const maxDateObj = new Date('{{ max_date|date:"Y-m-d" }}');
const daysDiff = Math.ceil((maxDateObj - minDateObj) / (1000 * 60 * 60 * 24));

let currentFilters = {
    gender: '{{ gender_filter }}',
    agegroup: '{{ agegroup_filter }}',
    state: '{{ state_filter }}',
    date_from: '{{ date_from }}',
    date_to: '{{ date_to }}'
};

function dateToSliderValue(date) {
    const dateObj = new Date(date);
    const daysSinceMin = Math.ceil((dateObj - minDateObj) / (1000 * 60 * 60 * 24));
    return Math.max(0, Math.min(100, (daysSinceMin / daysDiff) * 100));
}

function sliderValueToDate(value) {
    const dayOffset = (value / 100) * daysDiff;
    const resultDate = new Date(minDateObj);
    resultDate.setDate(resultDate.getDate() + dayOffset);
    return resultDate.toISOString().split('T')[0];
}

function formatDateDisplay(date) {
    return new Date(date).toLocaleDateString('en-CA');
}

function updateDateSlider() {
    const sliderFrom = document.getElementById('dateSliderFrom');
    const sliderTo = document.getElementById('dateSliderTo');
    
    let valueFrom = parseFloat(sliderFrom.value);
    let valueTo = parseFloat(sliderTo.value);
    
    if (valueFrom > valueTo) {
        [valueFrom, valueTo] = [valueTo, valueFrom];
        sliderFrom.value = valueFrom;
        sliderTo.value = valueTo;
    }
    
    const dateFrom = sliderValueToDate(valueFrom);
    const dateTo = sliderValueToDate(valueTo);
    
    document.getElementById('sliderFromLabel').textContent = formatDateDisplay(dateFrom);
    document.getElementById('sliderToLabel').textContent = formatDateDisplay(dateTo);
    
    currentFilters.date_from = dateFrom;
    currentFilters.date_to = dateTo;
    
    updateChart();
}

function applyFilter(filterType, value) {
    currentFilters[filterType] = value;
    updateChart();
}

function clearAllFilters() {
    currentFilters = { gender: '', agegroup: '', state: '', date_from: '', date_to: '' };
    document.getElementById('genderSelect').value = '';
    document.getElementById('ageSelect').value = '';
    document.getElementById('stateSelect').value = '';
    document.getElementById('dateSliderFrom').value = 0;
    document.getElementById('dateSliderTo').value = 100;
    document.getElementById('sliderFromLabel').textContent = formatDateDisplay(minDateObj.toISOString().split('T')[0]);
    document.getElementById('sliderToLabel').textContent = formatDateDisplay(maxDateObj.toISOString().split('T')[0]);
    updateChart();
}

function updateChart() {
    const chartContainer = document.getElementById('chartContainer');
    const responsesContainer = document.getElementById('responses-container');
    
    chartContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Updating chart...</p></div>';
    responsesContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading responses...</p></div>';
    
    const params = new URLSearchParams({
        post: postId,
        gender: currentFilters.gender,
        agegroup: currentFilters.agegroup,
        state: currentFilters.state,
        date_from: currentFilters.date_from,
        date_to: currentFilters.date_to
    });
    
    fetch(`?${params.toString()}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        chartContainer.innerHTML = data.sentiment_chart;
        
        document.getElementById('total-responses').textContent = data.total_responses;
        document.getElementById('response-count').textContent = data.total_responses;
        
        const scriptMatch = data.sentiment_chart.match(/<script[^>]*>([\s\S]*?)<\/script>/);
        if (scriptMatch && scriptMatch[1]) {
            try {
                eval(scriptMatch[1]);
            } catch (e) {
                console.error('Error executing Plotly script:', e);
            }
        }
        
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.pushState({}, '', newUrl);
        
        updateDropdownStyling();
        
        loadPageWithoutScroll(1);
    })
    .catch(error => {
        chartContainer.innerHTML = '<p class="text-danger text-center">Error updating chart. Please try again.</p>';
        console.error('Error:', error);
    });
}

function updateDropdownStyling() {
    const genderSelect = document.getElementById('genderSelect');
    const ageSelect = document.getElementById('ageSelect');
    const stateSelect = document.getElementById('stateSelect');
    
    if (genderSelect) genderSelect.classList.toggle('filtered', genderSelect.value !== '');
    if (ageSelect) ageSelect.classList.toggle('filtered', ageSelect.value !== '');
    if (stateSelect) stateSelect.classList.toggle('filtered', stateSelect.value !== '');
}

function loadPageWithoutScroll(pageNum) {
    const container = document.getElementById('responses-container');
    
    const params = new URLSearchParams({
        post: postId,
        gender: currentFilters.gender,
        agegroup: currentFilters.agegroup,
        state: currentFilters.state,
        date_from: currentFilters.date_from,
        date_to: currentFilters.date_to,
        page: pageNum
    });
    
    fetch(`?${params.toString()}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        container.innerHTML = data.html;
        attachPaginationListeners();
    })
    .catch(error => {
        container.innerHTML = '<p class="text-danger text-center">Error loading responses. Please try again.</p>';
        console.error('Error:', error);
    });
}

function loadPage(pageNum) {
    const container = document.getElementById('responses-container');
    
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading responses...</p></div>';
    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    const params = new URLSearchParams({
        post: postId,
        gender: currentFilters.gender,
        agegroup: currentFilters.agegroup,
        state: currentFilters.state,
        date_from: currentFilters.date_from,
        date_to: currentFilters.date_to,
        page: pageNum
    });
    
    fetch(`?${params.toString()}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        container.innerHTML = data.html;
        attachPaginationListeners();
    })
    .catch(error => {
        container.innerHTML = '<p class="text-danger text-center">Error loading responses. Please try again.</p>';
        console.error('Error:', error);
    });
}

function attachPaginationListeners() {
    document.querySelectorAll('.page-link-custom:not(.disabled)').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            if (page) loadPage(page);
        });
    });
}

// Initialize slider on page load
document.addEventListener('DOMContentLoaded', function() {
    attachPaginationListeners();
    updateDropdownStyling();
    
    // Set initial slider values if date filters were already applied
    if (currentFilters.date_from) {
        document.getElementById('dateSliderFrom').value = dateToSliderValue(currentFilters.date_from);
    }
    if (currentFilters.date_to) {
        document.getElementById('dateSliderTo').value = dateToSliderValue(currentFilters.date_to);
    }
});
</script>
{% endblock %}